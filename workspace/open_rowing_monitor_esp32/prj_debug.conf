# ==============================================================================
#  XTENSA / ESP32-S3 GDB COOPERATION
# ==============================================================================

# This is the big one you're missing. Without it, GDB can't walk
# the call stack on Xtensa because frame pointers are optimized out.
# Your current config has SPEED_OPTIMIZATIONS which strips these.
# The debug conf already has NO_OPTIMIZATIONS but make sure it's actually
# overriding — put this explicitly:
CONFIG_SPEED_OPTIMIZATIONS=n
CONFIG_SIZE_OPTIMIZATIONS=n

# Keeps function names in the ELF so GDB resolves symbols properly
# instead of showing raw addresses like 0x20685580
CONFIG_DEBUG_INFO=y
# CONFIG_DEBUG_INFO_DWARF_STANDARD=y
# CONFIG_DEBUG_INFO_DWARF_VERSION=4

# ==============================================================================
#  FAULT HANDLER — GET THE CRASH BEFORE THE DOUBLE EXCEPTION
# ==============================================================================

# Already have FAULT_DUMP=2, good. Add these:

# Forces the fault handler to print to UART synchronously before
# the system dies. Without this, deferred logging might not flush.
CONFIG_LOG_MODE_IMMEDIATE=y

# Dumps the full memory region around the stack pointer at crash time.
# This is how you find what actually overwrote your stack.
CONFIG_DEBUG_COREDUMP_MEMORY_DUMP_MIN=y

# ==============================================================================
#  THREAD VISIBILITY IN GDB
# ==============================================================================

# These let GDB list and switch between threads with "info threads"
# and "thread <N>" instead of just seeing one frame
CONFIG_THREAD_MONITOR=y
CONFIG_THREAD_NAME=y
CONFIG_THREAD_STACK_INFO=y
# CONFIG_THREAD_STACK_SENTINEL=y

# This one is key — it makes each thread's stack visible in the
# symbol table so GDB can locate them in memory
# CONFIG_THREAD_CONTEXT_INFO=y

# ==============================================================================
#  STACK PROTECTION — CATCH IT BEFORE IT CORRUPTS
# ==============================================================================

# This one catches the overflow at the boundary instead of letting
# it silently corrupt adjacent memory first
# CONFIG_ARCH_STACK_GUARD=y

#  CRASH DEBUGGING CONFIGURATION
#  Add this to your prj_debug.conf to get better crash information
# ==============================================================================

# Built in monitor to check tread stack usage and overall heap usage
CONFIG_SYSM_ENABLE_MONITORING=y
CONFIG_GPIO_ENABLE_PHYSICS_PROFILING=y

CONFIG_INIT_STACKS=y
CONFIG_THREAD_STACK_INFO=y

# Enable coredump for crash analysis
CONFIG_DEBUG_COREDUMP=y
CONFIG_DEBUG_COREDUMP_BACKEND_LOGGING=y
CONFIG_DEBUG_COREDUMP_MEMORY_DUMP_MIN=y

# Enable exception handling details
CONFIG_EXCEPTION_DEBUG=y

# Enable watchdog (to catch infinite loops)
CONFIG_WATCHDOG=y

# Enable fault dump (detailed register dump on crash)
CONFIG_FAULT_DUMP=2

# Enable thread monitoring to see what thread crashed
CONFIG_THREAD_MONITOR=y
CONFIG_THREAD_NAME=y
CONFIG_THREAD_STACK_INFO=y


# Enable heap poisoning (catches use-after-free)
CONFIG_SYS_HEAP_VALIDATE=y

# Enable stack canaries (catches stack overflows)
CONFIG_STACK_CANARIES=y
CONFIG_STACK_SENTINEL=y

# Increase log buffer to catch more before crash
CONFIG_LOG_BUFFER_SIZE=4096

# Disable optimizations for easier debugging
CONFIG_NO_OPTIMIZATIONS=y
# CONFIG_DEBUG_OPTIMIZATIONS=y

# ==============================================================================
#  BLE DEBUGGING FOR ZEPHYR 4.1.0
# ==============================================================================
CONFIG_DEBUG_THREAD_INFO=y
# # Enable BLE logging subsystem
# # CONFIG_BT_LOG=y

# # Set BLE log level to DEBUG
# CONFIG_BT_LOG_LEVEL_DBG=y

# # Enable specific BLE module logging
# CONFIG_BT_HCI_CORE_LOG_LEVEL_DBG=y
# CONFIG_BT_CONN_LOG_LEVEL_DBG=y
# CONFIG_BT_GATT_LOG_LEVEL_DBG=y
# CONFIG_BT_ATT_LOG_LEVEL_DBG=y
# CONFIG_BT_L2CAP_LOG_LEVEL_DBG=y

# # Monitor BLE buffer usage (very useful for debugging)
# # CONFIG_BT_DEBUG_MONITOR=y

# # If you want to see HCI commands (very verbose!):
# # CONFIG_BT_HCI_LOG_LEVEL_DBG=y

# # Note: The old CONFIG_BT_DEBUG_* options were deprecated in Zephyr 3.x
# # and removed in 4.x. Use the _LOG_LEVEL_ variants above instead.
